#!/usr/bin/env node

const os = require('os');
const path = require('path');
const chalk = require('chalk');
const pkg = require(path.resolve(__dirname, '..', 'package.json'));

const { findPackageJson } = require('../dist/src/npm');
const packageDir = findPackageJson(process.cwd());
const packageJson = require(packageDir);

const hoistEnv = [
  'api',
  'profile',
  'project',
  'connect_channel',
];

function optionDefault(opt, defaultValue) {
  return process.env[`MIIX_${opt.toUpperCase()}`] || defaultValue;
}

const execute = argv => {
  hoistEnv.forEach(opt => {
    if (argv[opt] !== undefined) {
      process.env[`MIIX_${opt.toUpperCase()}`] = argv[opt];
    }
  });

  Promise.resolve(require(`../dist/src/commands/${argv._[0]}`).default(argv))
    .then(() => process.exit(0))
    .catch(err => {
      const message = String(err.stack || err.message || err);
      console.error(err.dontColor ? message : chalk.red(message));
      process.exit(1);
    });
};

const yargs = require('yargs')
  .version(pkg.version)
  .option('profile', {
    description: 'Profile to use, stores authentication and config credentials',
    default: optionDefault('profile', path.join(os.homedir(), '.miixrc')),
  })
  .option('project', {
    description: 'Path to your interactive project',
    default: optionDefault('project', path.dirname(packageDir)),
  })
  .option('api', {
    description: 'Mixer API address',
    default: optionDefault('api', 'https://mixer.com'),
  })
  .command('login', 'Authenticates your machine with Mixer', {}, execute)
  .command('logout', 'Clears your Mixer profile from this machine', {}, execute)
  .command('whoami', 'Prints your Mixer username and ID', {}, execute)
  .command(
    'serve',
    'Boots up an interactive development server.',
    argv =>
      argv
        .usage('miix serve [-- <webpack-dev-server args>]')
        .example('miix serve', 'Boot a server on http://localhost:8080')
        .example(
          'miix serve -- --port=1234',
          'Pass in custom webpack-dev-server arguments (see webpack-dev-server --help)'
        ),
    execute
  )
  .command(
    'pack',
    'Creates a packaged version of your controls as uploaded in `miix publish`. Useful for debugging.',
    {},
    execute
  )
  .command(
    'upload',
    'Uploads your controls to Mixer so you can use them on your channel. Controls are private until you run `miix publish`.',
    argv =>
      argv.option('tarball', {
        description: 'Control archive to upload as created with `miix pack`. ' +
          'Will be created automatically if one is not specified.'
      }),
    execute
  )
  .command(
    'unpublish',
    'Unpublishes a previously-published version of your Interactive controls.',
    argv =>
      argv
      .option('package', {
        description: 'The package name and version to unpublish',
        default: `${packageJson.name}@${packageJson.version}`,
      }),
    execute
  )
  .command('debug-metadata', false, {}, execute)
  .strict()
  .help()
  .demandCommand().argv;
